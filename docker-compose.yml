version: '3.9'

services:
  # ===========================================================================
  # PostgreSQL with pgvector extension
  # ===========================================================================
  postgres:
    image: pgvector/pgvector:pg15
    container_name: biomedical-postgres
    environment:
      POSTGRES_USER: biomedical
      POSTGRES_PASSWORD: dev_password
      POSTGRES_DB: knowledge_platform
    ports:
      - "5432:5432"
    volumes:
      - postgres_data:/var/lib/postgresql/data
      - ./scripts/init-db.sql:/docker-entrypoint-initdb.d/01-init.sql:ro
    healthcheck:
      test: ["CMD-SHELL", "pg_isready -U biomedical -d knowledge_platform"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 10s
    networks:
      - biomedical-network

  # ===========================================================================
  # LocalStack for AWS services (S3, SQS, Secrets Manager)
  # ===========================================================================
  localstack:
    image: localstack/localstack:3.0
    container_name: biomedical-localstack
    environment:
      SERVICES: s3,sqs,secretsmanager
      DEFAULT_REGION: us-east-1
      EAGER_SERVICE_LOADING: 1
      DEBUG: 0
    ports:
      - "4566:4566"
    volumes:
      - localstack_data:/var/lib/localstack
      - ./scripts/init-localstack.sh:/etc/localstack/init/ready.d/init-localstack.sh:ro
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:4566/_localstack/health"]
      interval: 10s
      timeout: 5s
      retries: 5
      start_period: 15s
    networks:
      - biomedical-network

  # ===========================================================================
  # Ingestion Service
  # ===========================================================================
  ingestion:
    build:
      context: .
      dockerfile: services/ingestion/Dockerfile
    container_name: biomedical-ingestion
    environment:
      DATABASE_URL: postgresql://biomedical:dev_password@postgres:5432/knowledge_platform
      AWS_ENDPOINT_URL: http://localstack:4566
      AWS_REGION: us-east-1
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      S3_BUCKET_RAW_DOCUMENTS: biomedical-raw-documents
      S3_BUCKET_PROCESSED_CHUNKS: biomedical-processed-chunks
      SQS_INGESTION_QUEUE_URL: http://localstack:4566/000000000000/ingestion-queue
      LOG_LEVEL: DEBUG
      ENVIRONMENT: development
    ports:
      - "8001:8000"
    depends_on:
      postgres:
        condition: service_healthy
      localstack:
        condition: service_healthy
    volumes:
      - ./services/ingestion:/app/services/ingestion:ro
      - ./services/shared:/app/services/shared:ro
    networks:
      - biomedical-network
    restart: unless-stopped

  # ===========================================================================
  # Retrieval Service
  # ===========================================================================
  retrieval:
    build:
      context: .
      dockerfile: services/retrieval/Dockerfile
    container_name: biomedical-retrieval
    environment:
      DATABASE_URL: postgresql://biomedical:dev_password@postgres:5432/knowledge_platform
      AWS_ENDPOINT_URL: http://localstack:4566
      AWS_REGION: us-east-1
      AWS_ACCESS_KEY_ID: test
      AWS_SECRET_ACCESS_KEY: test
      LOG_LEVEL: DEBUG
      ENVIRONMENT: development
      BEDROCK_EMBEDDING_MODEL_ID: amazon.titan-embed-text-v1
    ports:
      - "8000:8000"
    depends_on:
      postgres:
        condition: service_healthy
      localstack:
        condition: service_healthy
    volumes:
      - ./services/retrieval:/app/services/retrieval:ro
      - ./services/shared:/app/services/shared:ro
    networks:
      - biomedical-network
    restart: unless-stopped

  # ===========================================================================
  # Redis for caching (optional, uncomment if needed)
  # ===========================================================================
  # redis:
  #   image: redis:7-alpine
  #   container_name: biomedical-redis
  #   ports:
  #     - "6379:6379"
  #   volumes:
  #     - redis_data:/data
  #   healthcheck:
  #     test: ["CMD", "redis-cli", "ping"]
  #     interval: 10s
  #     timeout: 5s
  #     retries: 5
  #   networks:
  #     - biomedical-network

volumes:
  postgres_data:
    driver: local
  localstack_data:
    driver: local
  # redis_data:
  #   driver: local

networks:
  biomedical-network:
    driver: bridge
